<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    const API = "http://127.0.0.1:9000";
    const token = localStorage.getItem("company_token");
    if (!token) window.location.href = "login.html";
  </script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">User Management</h1>
    <button onclick="goBack()" class="text-blue-600 underline">‚Üê Back</button>
  </div>

  <!-- ADD USER -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-4">Add New User</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
      <input id="emp_id" placeholder="Employee ID" class="border p-2 rounded" />
      <input id="name" placeholder="Name" class="border p-2 rounded" />
      <input id="email" placeholder="Email (optional)" class="border p-2 rounded" />
      <input id="password" type="password" placeholder="Password" class="border p-2 rounded" />
    </div>

    <label class="flex items-center gap-2 mb-3">
      <input type="checkbox" id="is_admin" />
      <span class="text-sm">Company Admin</span>
    </label>

    <button onclick="addUser()" class="bg-blue-600 text-white px-4 py-2 rounded">
      Add User
    </button>

    <p id="addResult" class="mt-2 text-sm"></p>
  </div>

  <!-- TABS -->
  <div class="mb-4 flex gap-4">
    <button onclick="showTab('users')" id="tab-users"
      class="font-medium border-b-2 border-blue-600 pb-1">
      Users
    </button>
    <button onclick="showTab('sessions')" id="tab-sessions"
      class="font-medium text-gray-500 pb-1">
      User Sessions
    </button>
    <button disabled class="font-medium text-gray-400 pb-1">
      Roles (Coming Soon)
    </button>
  </div>

  <!-- USERS TABLE -->
  <div id="usersTab" class="bg-white p-4 rounded shadow">
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">Emp ID</th>
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-left">Email</th>
          <th class="p-2 text-left">Admin</th>
          <th class="p-2 text-left">Status</th>
          <th class="p-2 text-left">Action</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>

  <!-- SESSIONS TABLE -->
  <div id="sessionsTab" class="bg-white p-4 rounded shadow hidden">
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Emp ID</th>
          <th class="p-2">IP</th>
          <th class="p-2">Login</th>
          <th class="p-2">Expires</th>
          <th class="p-2">Action</th>
        </tr>
      </thead>
      <tbody id="sessionTable"></tbody>
    </table>
  </div>

  <!-- EDIT USER MODAL -->
  <div id="editModal"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded p-6 w-full max-w-md">
      <h3 class="text-lg font-bold mb-4">Edit User</h3>

      <input type="hidden" id="edit_user_id" />

      <input id="edit_name" class="border p-2 rounded w-full mb-3" placeholder="Name" />
      <input id="edit_email" class="border p-2 rounded w-full mb-3" placeholder="Email" />

      <select id="edit_status" class="border p-2 rounded w-full mb-3">
        <option value="active">Active</option>
        <option value="leave">Leave</option>
        <option value="terminated">Terminated</option>
      </select>

      <label class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="edit_admin" />
        <span>Company Admin</span>
      </label>

      <div class="flex justify-end gap-3">
        <button onclick="closeEditModal()">Cancel</button>
        <button onclick="updateUser()" class="bg-blue-600 text-white px-4 py-2 rounded">
          Save
        </button>
      </div>
    </div>
  </div>

<script>
function showTab(tab) {
  document.getElementById("usersTab").classList.toggle("hidden", tab !== "users");
  document.getElementById("sessionsTab").classList.toggle("hidden", tab !== "sessions");

  document.getElementById("tab-users").classList.toggle("border-blue-600", tab === "users");
  document.getElementById("tab-sessions").classList.toggle("border-blue-600", tab === "sessions");
}

/* ===== USERS ===== */

async function loadUsers() {
  const res = await fetch(`${API}/company/users`, {
    headers: { Authorization: "Bearer " + token }
  });
  const users = await res.json();

  const table = document.getElementById("userTable");
  table.innerHTML = "";

  users.forEach(u => {
    table.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${u.emp_id}</td>
        <td class="p-2">${u.name}</td>
        <td class="p-2">${u.email || "-"}</td>
        <td class="p-2">${u.is_company_admin ? "Yes" : "No"}</td>
        <td class="p-2">${u.status}</td>
        <td class="p-2">
          <button class="text-blue-600 mr-2" onclick='openEditModal(${JSON.stringify(u)})'>Edit</button>
        </td>
      </tr>
    `;
  });
}

async function addUser() {
  const payload = {
    emp_id: emp_id.value,
    name: name.value,
    email: email.value || null,
    password: password.value,
    is_company_admin: is_admin.checked
  };

  const res = await fetch(`${API}/company/users`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  addResult.innerText = data.message || data.detail;
  loadUsers();
}

/* ===== EDIT ===== */

function openEditModal(user) {
  edit_user_id.value = user.id;
  edit_name.value = user.name;
  edit_email.value = user.email || "";
  edit_status.value = user.status;
  edit_admin.checked = user.is_company_admin;
  editModal.classList.remove("hidden");
  editModal.classList.add("flex");
}

function closeEditModal() {
  editModal.classList.add("hidden");
}

async function updateUser() {
  const id = edit_user_id.value;

  const payload = {
    name: edit_name.value,
    email: edit_email.value || null,
    status: edit_status.value,
    is_company_admin: edit_admin.checked
  };

  await fetch(`${API}/company/users/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  closeEditModal();
  loadUsers();
}

/* ===== SESSIONS ===== */

function formatDate(v) {
  return new Date(v).toLocaleString();
}

async function loadSessions() {
  const res = await fetch(`${API}/company/user-sessions`, {
    headers: { Authorization: "Bearer " + token }
  });
  const sessions = await res.json();

  const table = document.getElementById("sessionTable");
  table.innerHTML = "";

  sessions.forEach(s => {
    table.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${s.name}</td>
        <td class="p-2">${s.emp_id}</td>
        <td class="p-2">${s.ip_address}</td>
        <td class="p-2">${formatDate(s.login_at)}</td>
        <td class="p-2">${formatDate(s.expires_at)}</td>
        <td class="p-2">
          <button class="text-red-600" onclick="terminateSession(${s.session_id})">
            Expire
          </button>
        </td>
      </tr>
    `;
  });
}

async function terminateSession(id) {
  if (!confirm("Terminate this session?")) return;

  await fetch(`${API}/company/user-sessions/${id}`, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });

  loadSessions();
}

/* ===== HELPERS ===== */

function goBack() {
  window.location.href = "home.html";
}

loadUsers();
loadSessions();
</script>

</body>
</html>
