<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">

<div class="max-w-5xl mx-auto p-6 space-y-6">

  <!-- HEADER -->
  <div class="bg-white rounded-lg shadow p-6 flex justify-between items-center">
    <div>
      <h1 id="empName" class="text-2xl font-semibold">Employee Name</h1>
      <p id="empId" class="text-sm text-gray-500">EMP-XXX</p>
    </div>
    <span id="empStatus"
      class="px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
      Status
    </span>
  </div>

  <!-- BASIC INFO -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">Basic Information</h2>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="text-gray-500">Employee ID</p>
        <p id="fieldEmpId" class="font-medium">—</p>
      </div>
      <div>
        <p class="text-gray-500">Email</p>
        <p id="fieldEmail" class="font-medium">—</p>
      </div>
      <div>
        <p class="text-gray-500">Company</p>
        <p id="fieldCompany" class="font-medium">—</p>
      </div>
      <div>
        <p class="text-gray-500">Company Admin</p>
        <p id="fieldAdmin" class="font-medium">—</p>
      </div>
    </div>
  </div>

  <!-- ROLE & ACCESS -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">Role & Access</h2>

    <div class="mb-4">
      <p class="text-gray-500 text-sm mb-1">Assigned Roles</p>
      <div id="rolesContainer" class="flex flex-wrap gap-2"></div>
    </div>

    <div>
      <p class="text-gray-500 text-sm mb-1">Enabled Features</p>
      <ul id="featuresList" class="list-disc list-inside text-sm"></ul>
    </div>
  </div>

  <!-- CONTACT INFO -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Contact Information</h2>
      <button id="editBtn"
        class="hidden text-sm text-blue-600 hover:underline">
        Edit
      </button>
    </div>

    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="text-gray-500">Phone</p>
        <p id="fieldPhone" class="font-medium"></p>
        <input id="inputPhone" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div>
        <p class="text-gray-500">Alternate Phone</p>
        <p id="fieldAltPhone" class="font-medium"></p>
        <input id="inputAltPhone" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div class="col-span-2">
        <p class="text-gray-500">Address Line 1</p>
        <p id="fieldAddr1" class="font-medium"></p>
        <input id="inputAddr1" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div class="col-span-2">
        <p class="text-gray-500">Address Line 2</p>
        <p id="fieldAddr2" class="font-medium"></p>
        <input id="inputAddr2" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div>
        <p class="text-gray-500">City</p>
        <p id="fieldCity" class="font-medium"></p>
        <input id="inputCity" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div>
        <p class="text-gray-500">State</p>
        <p id="fieldState" class="font-medium"></p>
        <input id="inputState" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div>
        <p class="text-gray-500">Postal Code</p>
        <p id="fieldPostal" class="font-medium"></p>
        <input id="inputPostal" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div>
        <p class="text-gray-500">Country</p>
        <p id="fieldCountry" class="font-medium"></p>
        <input id="inputCountry" class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>

      <div class="col-span-2">
        <p class="text-gray-500">Emergency Contact</p>
        <p id="fieldEmergency" class="font-medium"></p>
        <input id="inputEmergencyName" placeholder="Name"
          class="hidden w-full border rounded px-2 py-1 text-sm mb-2" />
        <input id="inputEmergencyPhone" placeholder="Phone"
          class="hidden w-full border rounded px-2 py-1 text-sm" />
      </div>
    </div>

    <div id="actionBtns" class="hidden mt-6 flex gap-3">
      <button onclick="saveProfile()"
        class="px-4 py-2 bg-blue-600 text-white rounded text-sm">
        Save
      </button>
      <button onclick="location.reload()"
        class="px-4 py-2 bg-gray-200 rounded text-sm">
        Cancel
      </button>
    </div>
  </div>

  <!-- ACTIVITY -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">Activity Snapshot</h2>
    <p class="text-sm text-gray-500">
      Last Login: <span id="fieldLastLogin" class="font-medium">—</span>
    </p>
  </div>

<!-- ATTENDANCE (SELF ONLY) -->
<div id="attendanceSection" class="bg-white rounded-lg shadow p-6 hidden">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold">My Attendance</h2>

    <input type="month" id="attendanceMonth"
      class="border rounded px-2 py-1 text-sm" />
  </div>

  <!-- SUMMARY -->
  <div class="grid grid-cols-4 gap-4 text-sm mb-6">
    <div class="bg-gray-50 rounded p-3 text-center">
      <p class="text-gray-500">Present</p>
      <p id="attPresent" class="text-xl font-semibold">0</p>
    </div>
    <div class="bg-gray-50 rounded p-3 text-center">
      <p class="text-gray-500">Absent</p>
      <p id="attAbsent" class="text-xl font-semibold">0</p>
    </div>
    <div class="bg-gray-50 rounded p-3 text-center">
      <p class="text-gray-500">Leave</p>
      <p id="attLeave" class="text-xl font-semibold">0</p>
    </div>
    <div class="bg-gray-50 rounded p-3 text-center">
      <p class="text-gray-500">Attendance %</p>
      <p id="attPercent" class="text-xl font-semibold">0%</p>
    </div>
  </div>

  <!-- TABLE -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-3 py-2 text-left">Date</th>
          <th class="px-3 py-2 text-left">Status</th>
          <th class="px-3 py-2 text-left">Marked By</th>
          <th class="px-3 py-2 text-left">Marked At</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
  </div>
</div>

<!-- LEAVES (SELF ONLY) -->
<div id="leaveSection" class="bg-white rounded-lg shadow p-6 hidden">

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold">My Leave Requests</h2>
    <button onclick="openLeaveForm()"
      class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm">
      Apply Leave
    </button>
  </div>

  <!-- LEAVE TABLE -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-3 py-2 text-left">Type</th>
          <th class="px-3 py-2 text-left">From</th>
          <th class="px-3 py-2 text-left">To</th>
          <th class="px-3 py-2 text-left">Days</th>
          <th class="px-3 py-2 text-left">Status</th>
          <th class="px-3 py-2 text-left">Action</th>
        </tr>
      </thead>
      <tbody id="leaveTable"></tbody>
    </table>
  </div>
</div>

<!-- APPLY LEAVE MODAL -->
<div id="leaveModal"
  class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <h3 class="text-lg font-semibold mb-4">Apply Leave</h3>

    <div class="space-y-3 text-sm">
      <div>
        <label class="text-gray-500">Leave Type</label>
        <select id="leaveType" class="w-full border rounded px-2 py-1">
          <option value="Casual">Casual</option>
          <option value="Sick">Sick</option>
          <option value="Earned">Earned</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-gray-500">Start Date</label>
          <input type="date" id="leaveStart"
            class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="text-gray-500">End Date</label>
          <input type="date" id="leaveEnd"
            class="w-full border rounded px-2 py-1" />
        </div>
      </div>

      <div>
        <label class="text-gray-500">Reason</label>
        <textarea id="leaveReason"
          class="w-full border rounded px-2 py-1 text-sm"></textarea>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-5">
      <button onclick="closeLeaveForm()"
        class="px-3 py-1.5 bg-gray-200 rounded text-sm">
        Cancel
      </button>
      <button onclick="submitLeave()"
        class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm">
        Submit
      </button>
    </div>
  </div>
</div>
<!-- LEAVES (SELF ONLY) -->
<div id="leaveSection" class="bg-white rounded-lg shadow p-6 hidden">

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold">My Leave Requests</h2>
    <button onclick="openLeaveForm()"
      class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm">
      Apply Leave
    </button>
  </div>

  <!-- LEAVE TABLE -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-3 py-2 text-left">Type</th>
          <th class="px-3 py-2 text-left">From</th>
          <th class="px-3 py-2 text-left">To</th>
          <th class="px-3 py-2 text-left">Days</th>
          <th class="px-3 py-2 text-left">Status</th>
          <th class="px-3 py-2 text-left">Action</th>
        </tr>
      </thead>
      <tbody id="leaveTable"></tbody>
    </table>
  </div>
</div>

<!-- APPLY LEAVE MODAL -->
<div id="leaveModal"
  class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <h3 class="text-lg font-semibold mb-4">Apply Leave</h3>

    <div class="space-y-3 text-sm">
      <div>
        <label class="text-gray-500">Leave Type</label>
        <select id="leaveType" class="w-full border rounded px-2 py-1">
          <option value="Casual">Casual</option>
          <option value="Sick">Sick</option>
          <option value="Earned">Earned</option>
          <option value="Unpaid">Unpaid</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-gray-500">Start Date</label>
          <input type="date" id="leaveStart"
            class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="text-gray-500">End Date</label>
          <input type="date" id="leaveEnd"
            class="w-full border rounded px-2 py-1" />
        </div>
      </div>

      <div>
        <label class="text-gray-500">Reason</label>
        <textarea id="leaveReason"
          class="w-full border rounded px-2 py-1 text-sm"></textarea>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-5">
      <button onclick="closeLeaveForm()"
        class="px-3 py-1.5 bg-gray-200 rounded text-sm">
        Cancel
      </button>
      <button onclick="submitLeave()"
        class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm">
        Submit
      </button>
    </div>
  </div>
</div>

<!-- LEAVE DETAILS MODAL -->
<div id="leaveDetailsModal"
  class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
    <h3 class="text-lg font-semibold mb-4">Leave Details</h3>

    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="text-gray-500">Leave Type</p>
        <p id="ldType" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Status</p>
        <p id="ldStatus" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Start Date</p>
        <p id="ldStart" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">End Date</p>
        <p id="ldEnd" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Total Days</p>
        <p id="ldDays" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Applied At</p>
        <p id="ldApplied" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Reviewed By</p>
        <p id="ldReviewedBy" class="font-medium"></p>
      </div>

      <div>
        <p class="text-gray-500">Reviewed At</p>
        <p id="ldReviewedAt" class="font-medium"></p>
      </div>

      <div class="col-span-2">
        <p class="text-gray-500">Review Notes</p>
        <p id="ldNotes" class="font-medium text-gray-700"></p>
      </div>
    </div>

    <div class="flex justify-end mt-6">
      <button onclick="closeLeaveDetails()"
        class="px-4 py-2 bg-gray-200 rounded text-sm">
        Close
      </button>
    </div>
  </div>
</div>



<!-- CHANGE PASSWORD -->

<div id="passwordSection" class="bg-white rounded-lg shadow p-6">
  <h2 class="text-lg font-semibold mb-4">Change Password</h2>

  <div class="grid grid-cols-2 gap-4 text-sm">
    <div class="col-span-2">
      <label class="text-gray-500">Current Password</label>
      <input id="currentPassword" type="password"
        class="w-full border rounded px-2 py-1 text-sm" />
    </div>

    <div>
      <label class="text-gray-500">New Password</label>
      <input id="newPassword" type="password"
        class="w-full border rounded px-2 py-1 text-sm" />
    </div>

    <div>
      <label class="text-gray-500">Confirm New Password</label>
      <input id="confirmPassword" type="password"
        class="w-full border rounded px-2 py-1 text-sm" />
    </div>
  </div>

  <div class="mt-4">
    <button onclick="changePassword()"
      class="px-4 py-2 bg-red-600 text-white rounded text-sm">
      Update Password
    </button>
  </div>
</div>



</div>

<script>
  const API = "http://127.0.0.1:9000";
  const token = localStorage.getItem("company_token");
  
  // 1. Get the ID of the user we are VIEWING from the URL
  const urlParams = new URLSearchParams(window.location.search);
  const viewedUserId = urlParams.get("user_id");

  // 2. Helper function to decode the JWT Token to find out who is LOGGED IN
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  // 3. Determine if "isSelf"
  let isSelf = false;
  
  if (token && viewedUserId) {
    const payload = parseJwt(token);
    // We check common JWT ID fields ('id', 'user_id', or 'sub')
    const loggedInId = payload.id || payload.user_id || payload.sub;
    
    // Compare Logged In ID vs Viewed ID
    if (Number(loggedInId) === Number(viewedUserId)) {
      isSelf = true;
    }
  }

  // 4. Hide restricted elements immediately if not self
  if (!isSelf) {
    const editBtn = document.getElementById("editBtn");
    const actionBtns = document.getElementById("actionBtns");
    const passwordSection = document.getElementById("passwordSection");

    if (editBtn) editBtn.remove();
    if (actionBtns) actionBtns.remove();
    if (passwordSection) passwordSection.remove();
  }

  // 5. Fetch Profile Data
  fetch(`${API}/company/users/${viewedUserId}/profile`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to load profile");
    return res.json();
  })
  .then(data => {
    // Populate Basic Info
    document.getElementById("empName").innerText = data.basic.name;
    document.getElementById("empId").innerText = data.basic.emp_id;
    document.getElementById("empStatus").innerText = data.basic.status;

    document.getElementById("fieldEmpId").innerText = data.basic.emp_id;
    document.getElementById("fieldEmail").innerText = data.basic.email || "—";
    document.getElementById("fieldCompany").innerText = data.basic.company;
    document.getElementById("fieldAdmin").innerText = data.basic.is_company_admin ? "Yes" : "No";

    // Populate Roles
    const rolesContainer = document.getElementById("rolesContainer");
    rolesContainer.innerHTML = "";
    data.roles.forEach(r => {
      const b = document.createElement("span");
      b.className = "px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded";
      b.innerText = r;
      rolesContainer.appendChild(b);
    });

    // Populate Features
    const featuresList = document.getElementById("featuresList");
    featuresList.innerHTML = "";
    data.features.forEach(f => {
      const li = document.createElement("li");
      li.innerText = f.name;
      featuresList.appendChild(li);
    });

    // Populate Contact Info
    const p = data.profile || {};
    document.getElementById("fieldPhone").innerText = p.phone || "—";
    document.getElementById("fieldAltPhone").innerText = p.alternate_phone || "—";
    document.getElementById("fieldAddr1").innerText = p.address?.line1 || "—";
    document.getElementById("fieldAddr2").innerText = p.address?.line2 || "—";
    document.getElementById("fieldCity").innerText = p.address?.city || "—";
    document.getElementById("fieldState").innerText = p.address?.state || "—";
    document.getElementById("fieldPostal").innerText = p.address?.postal_code || "—";
    document.getElementById("fieldCountry").innerText = p.address?.country || "—";
    
    document.getElementById("fieldEmergency").innerText = p.emergency_contact?.name
      ? `${p.emergency_contact.name} (${p.emergency_contact.phone})`
      : "—";

    document.getElementById("fieldLastLogin").innerText = data.activity.last_login || "—";

    // Only show the "Edit" button if it is self (it was hidden via CSS class by default)
    // Note: If !isSelf, the button was removed from DOM entirely in step 4.
    if (isSelf) {
      const editBtn = document.getElementById("editBtn");
      if(editBtn) {
        editBtn.classList.remove("hidden");
        editBtn.onclick = enableEdit;
      }
    }
  })
  .catch(err => console.error(err));

  // --- Actions ---

  function enableEdit() {
    document.querySelectorAll("p[id^='field']").forEach(e => e.classList.add("hidden"));
    document.querySelectorAll("input").forEach(e => e.classList.remove("hidden"));
    document.getElementById("actionBtns").classList.remove("hidden");
    document.getElementById("editBtn").classList.add("hidden");
  }

  function saveProfile() {
    if (!isSelf) {
      alert("You are not allowed to perform this action.");
      return;
    }
    
    // Grab values
    const payload = {
      phone: document.getElementById("inputPhone").value,
      alternate_phone: document.getElementById("inputAltPhone").value,
      address_line_1: document.getElementById("inputAddr1").value,
      address_line_2: document.getElementById("inputAddr2").value,
      city: document.getElementById("inputCity").value,
      state: document.getElementById("inputState").value,
      postal_code: document.getElementById("inputPostal").value,
      country: document.getElementById("inputCountry").value,
      emergency_contact_name: document.getElementById("inputEmergencyName").value,
      emergency_contact_phone: document.getElementById("inputEmergencyPhone").value
    };

    fetch(`${API}/company/users/me/profile`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error();
      location.reload();
    })
    .catch(() => alert("Failed to update profile"));
  }

  function changePassword() {
    if (!isSelf) {
      alert("You are not allowed to perform this action.");
      return;
    }
    
    const current = document.getElementById("currentPassword").value;
    const next = document.getElementById("newPassword").value;
    const confirm = document.getElementById("confirmPassword").value;

    if (!current || !next || !confirm) {
      alert("All password fields are required");
      return;
    }

    if (next !== confirm) {
      alert("New passwords do not match");
      return;
    }

    if (next.length < 8) {
      alert("Password must be at least 8 characters long");
      return;
    }

    fetch(`${API}/company/users/me/password`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        current_password: current,
        new_password: next
      })
    })
    .then(res => {
      if (!res.ok) throw new Error();
      alert("Password updated successfully");
      document.getElementById("currentPassword").value = "";
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";
    })
    .catch(() => alert("Incorrect current password"));
  }

if (isSelf) {
  document.getElementById("attendanceSection").classList.remove("hidden");

  const monthInput = document.getElementById("attendanceMonth");
  const now = new Date();
  monthInput.value = now.toISOString().slice(0, 7);

  loadAttendance(monthInput.value);

  monthInput.onchange = () => loadAttendance(monthInput.value);
}

function loadAttendance(month) {
  // SUMMARY
  fetch(`${API}/company/attendance/user/${viewedUserId}/summary?month=${month}`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("attPresent").innerText = data.present;
    document.getElementById("attAbsent").innerText = data.absent;
    document.getElementById("attLeave").innerText = data.leave;
    document.getElementById("attPercent").innerText =
      `${data.attendance_percentage}%`;
  });

  // RECORDS
  fetch(`${API}/company/attendance/user/${viewedUserId}?month=${month}`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(rows => {
    const tbody = document.getElementById("attendanceTable");
    tbody.innerHTML = "";

    if (rows.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-gray-400 py-4">
            No attendance records
          </td>
        </tr>
      `;
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2">${r.date}</td>
        <td class="px-3 py-2">${r.status}</td>
        <td class="px-3 py-2">${r.marked_by || "-"}</td>
        <td class="px-3 py-2 text-gray-500">
          ${r.marked_at ? new Date(r.marked_at).toLocaleString() : "-"}
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

if (isSelf) {
  document.getElementById("leaveSection").classList.remove("hidden");
  loadMyLeaves();
}

function loadMyLeaves() {
  fetch(`${API}/company/leaves/me`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(rows => {
    const tbody = document.getElementById("leaveTable");
    tbody.innerHTML = "";

    if (rows.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-gray-400 py-4">
            No leave requests found
          </td>
        </tr>
      `;
      return;
    }

    rows.forEach(l => {
    const tr = document.createElement("tr");
    tr.className = "cursor-pointer hover:bg-gray-50";
    tr.onclick = () => openLeaveDetails(l);


      const badgeColor =
        l.status === "Approved" ? "bg-green-100 text-green-700" :
        l.status === "Rejected" ? "bg-red-100 text-red-700" :
        l.status === "Cancelled" ? "bg-gray-200 text-gray-600" :
        "bg-yellow-100 text-yellow-700";

      tr.innerHTML = `
        <td class="px-3 py-2">${l.leave_type}</td>
        <td class="px-3 py-2">${l.start_date}</td>
        <td class="px-3 py-2">${l.end_date}</td>
        <td class="px-3 py-2">${l.total_days}</td>
        <td class="px-3 py-2">
          <span class="px-2 py-0.5 rounded text-xs ${badgeColor}">
            ${l.status}
          </span>
        </td>
        <td class="px-3 py-2">
          ${
            l.status === "Pending"
              ? `<button class="text-red-600 text-xs"
                onclick="event.stopPropagation(); cancelLeave(${l.id})">Cancel</button>`
              : "-"
          }
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function openLeaveForm() {
  document.getElementById("leaveModal").classList.remove("hidden");
}

function closeLeaveForm() {
  document.getElementById("leaveModal").classList.add("hidden");
}

function submitLeave() {
  const payload = {
    leave_type: document.getElementById("leaveType").value,
    start_date: document.getElementById("leaveStart").value,
    end_date: document.getElementById("leaveEnd").value,
    reason: document.getElementById("leaveReason").value
  };

  if (!payload.start_date || !payload.end_date) {
    alert("Please select start and end dates");
    return;
  }

  fetch(`${API}/company/leaves`, {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error();
    closeLeaveForm();
    loadMyLeaves();
  })
  .catch(() => alert("Failed to submit leave"));
}

function cancelLeave(id) {
  if (!confirm("Cancel this leave request?")) return;

  fetch(`${API}/company/leaves/${id}/cancel`, {
    method: "PUT",
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => {
    if (!res.ok) throw new Error();
    loadMyLeaves();
  })
  .catch(() => alert("Unable to cancel leave"));
}

function openLeaveDetails(leave) {
  document.getElementById("ldType").innerText = leave.leave_type;
  document.getElementById("ldStatus").innerText = leave.status;
  document.getElementById("ldStart").innerText = leave.start_date;
  document.getElementById("ldEnd").innerText = leave.end_date;
  document.getElementById("ldDays").innerText = leave.total_days;
  document.getElementById("ldApplied").innerText =
    leave.applied_at
      ? new Date(leave.applied_at).toLocaleString()
      : "-";

  document.getElementById("ldReviewedBy").innerText =
    leave.reviewed_by || "—";

  document.getElementById("ldReviewedAt").innerText =
    leave.reviewed_at
      ? new Date(leave.reviewed_at).toLocaleString()
      : "—";

  document.getElementById("ldNotes").innerText =
    leave.review_notes || "—";

  document.getElementById("leaveDetailsModal").classList.remove("hidden");
}

function closeLeaveDetails() {
  document.getElementById("leaveDetailsModal").classList.add("hidden");
}


</script>

</body>
</html>
