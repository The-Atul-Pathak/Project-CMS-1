<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Management OS | Project Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
  </style>

  <script>
    const API = "http://127.0.0.1:9000";
    const token = localStorage.getItem("company_token");
    if (!token) window.location.href = "login.html";

    const params = new URLSearchParams(window.location.search);
    const projectId = params.get("project_id");
    if (!projectId) window.location.href = "projects.html";
  </script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex">

<!-- SIDEBAR -->
<aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col sticky top-0 h-screen">
  <div class="p-6 flex items-center gap-3">
    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">M</div>
    <span class="text-lg font-bold">Management OS</span>
  </div>

  <nav class="flex-1 px-4 space-y-1">
    <a href="/Project-CMS-1/Company/Frontend/projects.html" class="flex items-center gap-3 px-3 py-2 text-slate-600 rounded-lg font-medium hover:bg-slate-50">
      ← Back to Projects
    </a>
  </nav>

  <div class="p-4 border-t border-slate-100">
    <button onclick="logout()" class="w-full px-3 py-2 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-lg font-medium">
      Sign Out
    </button>
  </div>
</aside>

<!-- MAIN -->
<main class="flex-1">

  <!-- TOP BAR -->
  <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-10">
    <div class="text-sm text-slate-500">
      Delivery / <span class="text-slate-900 font-medium">Project Details</span>
    </div>
    <div id="topBarUser" class="text-sm font-medium text-slate-700"></div>
  </header>

  <!-- CONTENT -->
  <div class="p-8 max-w-7xl mx-auto">

    <!-- HEADER -->
    <div class="mb-6">
      <h1 id="projectName" class="text-3xl font-bold text-slate-900"></h1>
      <p id="projectMeta" class="text-slate-500 mt-1"></p>
    </div>

    <!-- ACTION BAR -->
    <div id="actionBar" class="mb-6"></div>

    <!-- TABS -->
    <div class="border-b border-slate-200 mb-6 flex gap-6 text-sm font-semibold">
      <button class="pb-3 tab-active" onclick="switchTab('overview', this)">Overview</button>
      <button class="pb-3 text-slate-500" onclick="switchTab('planning', this)">Planning</button>
      <button class="pb-3 text-slate-500" onclick="goToTasks()">Tasks</button>
      <button class="pb-3 text-slate-500" onclick="switchTab('activity', this)">Activity</button>
    </div>

    <!-- TAB CONTENT -->
    <div id="tabContent"></div>

  </div>
</main>

<script>
let projectData = null;

async function loadProject() {
  try {
    const meRes = await fetch(`${API}/company/me`, {
      headers: { Authorization: "Bearer " + token }
    });
    const me = await meRes.json();
    document.getElementById("topBarUser").innerText = me.user.name;

    const res = await fetch(`${API}/projects/${projectId}`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!res.ok) throw new Error();

    projectData = await res.json();
    renderHeader();
    renderActions();
    renderOverview();

  } catch (e) {
    logout();
  }
}

function renderHeader() {
  const p = projectData.project;
  document.getElementById("projectName").innerText = p.name;
  document.getElementById("projectMeta").innerText =
    `Status: ${p.status} • Team: ${p.team} • Leader: ${p.leader}`;
}

function renderActions() {
  const status = projectData.project.status;
  const bar = document.getElementById("actionBar");
  bar.innerHTML = "";

  if (status === "Assigned") {
    bar.innerHTML = `
      <button onclick="goToPlanning()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">
        Plan Project
      </button>
    `;
  }

  if (status === "Planned") {
    bar.innerHTML = `
      <button onclick="startProject()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
        Start Project
      </button>
    `;
  }

  if (status === "In Progress") {
    bar.innerHTML = `
      <button id="endProjectBtn"
        onclick="endProject()"
        class="px-4 py-2 bg-slate-900 text-white rounded-lg font-medium opacity-50 cursor-not-allowed">
        End Project
      </button>
    `;
    checkIfProjectCanEnd();
  }
}

async function checkIfProjectCanEnd() {
  const res = await fetch(`${API}/projects/${projectId}/tasks`, {
    headers: { Authorization: "Bearer " + token }
  });
  const tasks = await res.json();

  const pending = tasks.some(t => t.status !== "Done");

  const btn = document.getElementById("endProjectBtn");
  if (!pending) {
    btn.classList.remove("opacity-50", "cursor-not-allowed");
    btn.classList.add("bg-red-600", "hover:bg-red-700");
  }
}

async function endProject() {
  if (!confirm("Are you sure you want to mark this project as completed?")) return;

  const res = await fetch(`${API}/projects/${projectId}/complete`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  if (res.ok) {
    alert("Project marked as completed");
    window.location.href = "/projects.html";
  } else {
    const err = await res.json();
    alert(err.detail || "Unable to complete project");
  }
}


function renderOverview() {
  const p = projectData.project;
  const planning = projectData.planning;

  document.getElementById("tabContent").innerHTML = `
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">Project Status</h3>
        <p class="text-lg font-semibold">${p.status}</p>
      </div>

      <div>
        <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">Planned Timeline</h3>
        <p class="text-slate-700">
          ${planning ? planning[0] + " → " + planning[1] : "Not planned yet"}
        </p>
      </div>

      <div class="md:col-span-2">
        <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">Description</h3>
        <p class="text-slate-700">
          ${planning ? planning[2] : "No description added yet."}
        </p>
      </div>
    </div>
  `;
}

function renderPlanning() {
  const planning = projectData.planning;

  if (!planning) {
    document.getElementById("tabContent").innerHTML = `
      <div class="bg-slate-100 border border-dashed border-slate-300 rounded-xl p-10 text-center text-slate-500">
        Project planning not created yet.
      </div>
    `;
    return;
  }

  document.getElementById("tabContent").innerHTML = `
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm space-y-4">
      <div><b>Scope:</b> ${planning[3] || "-"}</div>
      <div><b>Priority:</b> ${planning[8] || "-"}</div>
      <div><b>Budget:</b> ${planning[7] || "-"}</div>
      <div><b>Risks:</b> ${planning[9] || "-"}</div>
      <div><b>Assumptions:</b> ${planning[10] || "-"}</div>
      <div><b>Dependencies:</b> ${planning[11] || "-"}</div>
    </div>
  `;
}

function renderActivity() {
  document.getElementById("tabContent").innerHTML = `
    <div class="bg-slate-100 border border-dashed border-slate-300 rounded-xl p-10 text-center text-slate-500">
      Activity log will appear here.
    </div>
  `;
}

function switchTab(tab, el) {
  document.querySelectorAll(".border-b button").forEach(b => {
    b.classList.remove("tab-active");
    b.classList.add("text-slate-500");
  });
  el.classList.add("tab-active");

  if (tab === "overview") renderOverview();
  if (tab === "planning") renderPlanning();
  if (tab === "activity") renderActivity();
}

function goToPlanning() {
  window.location.href = `/Project-CMS-1/Company/Frontend/project_planning.html?project_id=${projectId}`;
}

function goToTasks() {
  window.location.href = `/Project-CMS-1/Company/Frontend/tasks.html?project_id=${projectId}`;
}

async function startProject() {
  if (!confirm("Start this project?")) return;

  const res = await fetch(`${API}/projects/${projectId}/start`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });

  if (res.ok) location.reload();
  else alert("Unable to start project");
}

async function logout() {
  try {
    await fetch(`${API}/company/logout`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token }
    });
  } finally {
    localStorage.removeItem("company_token");
    window.location.href = "login.html";
  }
}

loadProject();
</script>

</body>
</html>
